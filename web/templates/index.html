<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q-less Solver</title>
    <!-- Include HTMX library -->
    <script src="https://unpkg.com/htmx.org@1.9.10" integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37i7HUxdLIhéŸ«LLQG+" crossorigin="anonymous"></script>
    <style>
        :root {
            --bg-color: #f4f4f4;
            --text-color: #333;
            --container-bg: #ffffff;
            --border-color: #ddd;
            --button-bg: #007bff;
            --button-hover: #0056b3;
            --results-bg: #f9f9f9;
            --grid-bg: #e0e0e0;
            --grid-cell-bg: #fff;
            --empty-cell-bg: #f0f0f0;
        }

        .dark-mode {
            --bg-color: #222;
            --text-color: #eee;
            --container-bg: #333;
            --border-color: #555;
            --button-bg: #4a8bff;
            --button-hover: #2a6ad2;
            --results-bg: #2b2b2b;
            --grid-bg: #444;
            --grid-cell-bg: #555;
            --empty-cell-bg: #3b3b3b;
        }

        body {
            font-family: sans-serif;
            margin: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .container {
            max-width: 800px;
            margin: auto;
            background: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: var(--text-color);
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        input[type="text"],
        input[type="number"] {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--container-bg);
            color: var(--text-color);
        }

        button {
            background-color: var(--button-bg);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background-color: var(--button-hover);
        }

        #results {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--results-bg);
        }

        .solution-grid {
            display: grid;
            gap: 2px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            padding: 5px;
            background-color: var(--grid-bg);
            max-width: fit-content;
        }

        .grid-row {
            display: flex;
        }

        .grid-cell {
            width: 30px;
            height: 30px;
            background-color: var(--grid-cell-bg);
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            text-transform: uppercase;
        }

        .grid-cell.empty {
            background-color: var(--empty-cell-bg);
        }

        .error {
            color: red;
            margin-top: 10px;
        }

        .theme-toggle {
            text-align: right;
            margin-bottom: 10px;
        }

        .theme-toggle button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 24px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Q-less Solver</h1>
        <div class="theme-toggle">
            <button id="dark-mode-toggle" aria-label="Toggle dark mode">
                ðŸŒ™
            </button>
        </div>

        <form id="image-form"
              hx-post="/solve-image/"
              hx-target="#results-container"
              hx-swap="innerHTML"
              hx-indicator="#loading-indicator"
              enctype="multipart/form-data">
            <div>
                <label for="image">Take a photo of your dice:</label>
                <input type="file" id="image" name="image" accept="image/*" capture="environment" required>
            </div>
            <button type="submit">Capture &amp; Solve</button>
        </form>

        <h3>Or manually enter letters:</h3>
        <form id="solver-form"
              hx-post="/solve-htmx/"
              hx-target="#results-container"
              hx-swap="innerHTML"
              hx-indicator="#loading-indicator">
            <div>
                <label for="letters">Enter your letters:</label>
                <input type="text" id="letters" name="letters" value="abcdef" required
                       pattern="^[A-Za-z]{12}$" minlength="12" maxlength="12"
                       title="Please enter exactly 12 letters">
            </div>
            <button type="submit">Solve</button>
            <span id="loading-indicator" style="display:none;">Loading...</span>
        </form>

        {% if default_grids %}
        <div id="default-grid-wrapper" style="text-align: center; margin-top: 20px;">
            <button id="prev-solution" aria-label="Previous solution">&lt;</button>
            <div id="solution-grid" class="solution-grid" style="display:inline-block;">
                {% for row in default_grids[0] %}
                <div class="grid-row">
                    {% for ch in row %}
                    <div class="grid-cell {% if ch == '.' %}empty{% endif %}">
                        {{ '' if ch == '.' else ch }}
                    </div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
            <button id="next-solution" aria-label="Next solution">&gt;</button>
        </div>
        {% endif %}

        <div id="results-container">
            <!-- Results will be loaded here by HTMX -->
            <p>Enter letters and click "Solve" to see results.</p>
        </div>
    </div>

    <script>
        // Dark mode toggle logic
        const toggleButton = document.getElementById('dark-mode-toggle');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
        const storedPreference = localStorage.getItem('darkMode');

        function setMode(enabled) {
            document.documentElement.classList.toggle('dark-mode', enabled);
            toggleButton.textContent = enabled ? 'â˜€' : 'ðŸŒ™';
        }

        if (storedPreference === null) {
            setMode(prefersDark.matches);
        } else {
            setMode(storedPreference === 'true');
        }

        toggleButton.addEventListener('click', () => {
            const enabled = !document.documentElement.classList.contains('dark-mode');
            localStorage.setItem('darkMode', enabled);
            setMode(enabled);
        });

        {% if default_grids %}
        const defaultGrids = {{ default_grids|tojson }};
        let currentGridIndex = 0;

        function renderGrid(idx) {
            const grid = defaultGrids[idx];
            const container = document.getElementById('solution-grid');
            container.innerHTML = '';
            grid.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'grid-row';
                for (const ch of row) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell' + (ch === '.' ? ' empty' : '');
                    cell.textContent = ch === '.' ? '' : ch;
                    rowDiv.appendChild(cell);
                }
                container.appendChild(rowDiv);
            });
        }

        document.getElementById('prev-solution').addEventListener('click', () => {
            currentGridIndex = (currentGridIndex - 1 + defaultGrids.length) % defaultGrids.length;
            renderGrid(currentGridIndex);
        });

        document.getElementById('next-solution').addEventListener('click', () => {
            currentGridIndex = (currentGridIndex + 1) % defaultGrids.length;
            renderGrid(currentGridIndex);
        });
        {% endif %}

        // Optional: Client-side script to handle JSON encoding for the form
        // if hx-ext="json-enc" is not sufficient or for more complex scenarios.
        // However, hx-ext="json-enc" should handle this for simple cases.
        // document.body.addEventListener('htmx:configRequest', function(evt) {
        //   if (evt.detail.elt.id === 'solver-form') {
        //     evt.detail.headers['Content-Type'] = 'application/json';
        //     // Parameters are already collected by htmx in evt.detail.parameters
        //     // For json-enc, htmx will automatically stringify it.
        //   }
        // });

        // To handle the HTMX response and render it (if it's not direct HTML from server)
        // This is more relevant if the server returns JSON that needs client-side templating.
        // But our FastAPI endpoint is set to return List[GridSolution],
        // and HTMX will try to put the string representation of this JSON into #results-container.
        // We need the server to return HTML for HTMX to swap directly.
        // So, the FastAPI endpoint /solve/ needs to return an HTML snippet.
        // This means the current plan step 3 (HTMX frontend) and step 2 (FastAPI endpoint) are tightly coupled.
        // The /solve/ endpoint should render a template with the solutions.
    </script>
</body>
</html>
